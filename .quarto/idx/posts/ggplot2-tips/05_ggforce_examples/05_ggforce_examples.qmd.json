{"title":"A couple of visualizations from ggforce","markdown":{"yaml":{"title":"A couple of visualizations from ggforce","date":"2021-12-31","categories":["Visualization"],"description":"The ggplot2-tips series is continued with a few example plots from the ggforce package","execute":{"message":false,"warning":false,"collapse":false},"editor_options":{"chunk_output_type":"console"}},"headingText":"| echo: false","containsRefs":false,"markdown":"\n\n```{r}\n#| results: 'hide'\nrenv::use(lockfile = \"renv.lock\")\n```\n\nIt is almost the beginning of a new year and I have decided to finish off this year with a quick blog post. \nAlso, friends were shaming me that I have been slacking off on this blog lately. \nTherefore, let's get started right away.\nWe'll keep things simple and look at a few cool plots from the `ggforce` package.\nOf course, we have already glimpsed at this package in the [previous installment](https://albert-rapp.deposts/ggplot2-tips/04_arranging_plots/04_arranging_plots.html) of this [ggplot2-tips series](https://albert-rapp.de/ggplot-series.html).\n\n## Mark Point Plots\n\nLet us first take a look at the `penguins` data set from the `palmerpenguins` package.\nSame as last time, this will be the dummy data set we use for plots but of course any other data set would be fine too.\n\n```{r, message=F, warning=F}\nlibrary(dplyr)\nlibrary(ggplot2)\ntheme_set(theme_light())\ndat <- palmerpenguins::penguins %>% \n  filter(!is.na(sex))\np <- dat %>% \n  ggplot(aes(bill_length_mm, flipper_length_mm, col = species)) +\n  geom_point()\np\n```\n\nVisually, we can see that the points are strongly grouped by species which makes sense as these kind of measurements often define a species.\nWith help from `ggforce` we can visually emphasize this grouping by drawing rectangles or ellipses around the groups.\n\n```{r}\nlibrary(ggforce)\nrect_plot <- p + \n  geom_mark_rect(size = 1)\nellipse_plot <- p + \n  geom_mark_ellipse(aes(fill = species), alpha = 0.25)\n\nlibrary(patchwork) # see last ggplot2-tips post\nrect_plot / ellipse_plot\n```\n\nThere is also a `geom_mark_hull()` function that requires the `concaveman` package to be installed. \nUsing this function, we can draw a hull around the points.\n\n```{r}\np +\n  geom_mark_hull(size = 1, concavity = 3)\n```\n\nBeware though that this hull is \"redrawn at draw time\", so your hull may look different when you zoom into the plot.\nAlso, let me point out that `geom_mark_hull()` has an argument `concavity` that allows you to make the hull \"more wiggly\".\n\n## Alluvial Plots\n\nWith `ggforce` you can easily draw so-called alluvial plots.\nOriginally, these are used to visualize a \"stream over time\" as for instance shown on [Wikipedia](https://en.wikipedia.org/wiki/Alluvial_diagram#/media/File:NeuroAlluvial2001-2007-691x273.png).\nBut the same visualization can be used to visualize \"composition of groups\" like so. \n\n```{r, echo=F}\nreshaped_dat <- dat %>% \n  mutate(\n    mass_group = factor(\n      cut_number(body_mass_g, 3),\n      labels = c(\"high\", \"medium\", \"low\")\n    )\n  ) %>%\n  count(species, island, sex, mass_group) %>% \n  gather_set_data(x = 1:4)\n\nreshaped_dat %>% \n  ggplot(aes(\n    x = factor(x, c(\"sex\", \"species\", \"island\", \"mass_group\")), \n    split = y, \n    id = id, \n    value = n\n  )) +\n  geom_parallel_sets(aes(fill = sex), alpha = 0.5) +\n  geom_parallel_sets_axes(axis.width = 0.2) +\n  geom_parallel_sets_labels(colour = 'white', size = 4) +\n  labs(x = element_blank()) + \n  scale_y_continuous(breaks = NULL) +\n  theme(text = element_text(size = 12)) +\n  scale_fill_brewer(palette = 'Set1')\n```\n\nFrom this plot, it is clear that unsurprisingly most of high weight penguins are male.\nWhat is maybe more surprising is that all Chinstrap penguins live on Dream.\nObviously, the first layer in this alluvial plot is sort of redundant as the color already codes the sex but for accessibility it is often encouraged to use some form of double encoding (e.g. different shape AND color for groups). \nThus, I find it practical and somewhat convenient to add this first layer.\n\nCreating this plot requires a couple of steps but `ggforce` has useful functions that make our life easier.\nMore precisely we will need to\n\n* count occurences in each subgroup and convert this in a suitable format for later plotting. `gather_set_data()` will help us doing that.\n* draw lines between subgroups with `geom_parallel_sets()` \n* draw boxes to identify subgroups with `geom_parallel_sets_axes()`\n* label the boxes with `geom_parallel_sets_labels`\n\nThe first step is processed as follows\n\n```{r}\nreshaped_dat <- dat %>% \n  mutate(\n    mass_group = factor(\n      cut_number(body_mass_g, 3),\n      labels = c(\"high\", \"medium\", \"low\")\n    )\n  ) %>%\n  count(species, island, sex, mass_group) %>% \n  gather_set_data(x = 1:4)\n```\n\nThis simply counts the occurences in each subgroup and then adds three columns `x`, `y` and `id` based on the subgroup labels.\nThese three new columns are necessary for generating the plot which is done as follows\n\n```{r}\nreshaped_dat %>% \n  ggplot(aes(\n    x = x, \n    split = y, \n    id = id, \n    value = n\n  )) +\n  geom_parallel_sets(aes(fill = sex), alpha = 0.5) +\n  geom_parallel_sets_axes(axis.width = 0.2) +\n  geom_parallel_sets_labels(colour = 'white', size = 4)\n```\n\nHere, value is the counts of the subgroups.\nAlso, notice that the splits on the x-axis is not in the same order as in my original plot.\nThe order can be easily changed by converting `x` to a factor whose levels have the desired ordering.\nThe complete code is\n\n```{r}\nreshaped_dat %>% \n  ggplot(aes(\n    x = factor(x, c(\"sex\", \"species\", \"island\", \"mass_group\")), \n    split = y, \n    id = id, \n    value = n\n  )) +\n  geom_parallel_sets(aes(fill = sex), alpha = 0.5) +\n  geom_parallel_sets_axes(axis.width = 0.2) +\n  geom_parallel_sets_labels(colour = 'white', size = 4) +\n  labs(x = element_blank()) + \n  scale_y_continuous(breaks = NULL) +\n  theme(text = element_text(size = 12)) +\n  scale_fill_brewer(palette = 'Set1')\n```\n\n## Voronoi Diagrams\n\nNext, let us explore Voronoi diagrams.\nThese are constructed from a set of \"center points\" which are used to form polygons such that these fill the whole plane and each polygons consists of the points that are closest to a polygon's center point.\nIf you found this somewhat confusing, then you are in luck because Wikipedia has a super neat [animation](https://de.wikipedia.org/wiki/Voronoi-Diagramm#/media/Datei:Voronoi_growth_euclidean.gif) that illustrates this concept.\n\nUsing bill and flipper lengths to define the center points' x- and y-coordinates, we can create a Voronoi diagram via `geom_voronoi_tile()` and `geom_voronoi_segment()` as follows.\n\n```{r, warning=F}\ndat %>% \n  ggplot(aes(bill_length_mm, flipper_length_mm, group = 1)) +\n  geom_voronoi_tile(aes(fill = species)) +\n  geom_voronoi_segment() +\n  scale_fill_brewer(palette = \"Set1\") +\n  theme_void()\n```\n\nHere, the lines between polygons are shown due to `geom_voronoi_segment()` and if we wish to get rid of the lines we can simply remove this layer.\nAlso, let us ignore possible applications of Voronoi diagrams[^application-voronoi] for a bit. \nWhat I really wanted to demonstrate is a small bit of Rtistry I found on [Twitter](https://twitter.com/kc_analytics/status/1416149064555667460?s=20) and found really cool.\n\n[^application-voronoi]: See [Wikipedia](https://en.wikipedia.org/wiki/Voronoi_diagram#Applications) if you're interested in a list of applications.\n\nWith a couple of random numbers and a bit of coloring one can create some visually appealing graphics (at least I like to think so).\nFirst, let's take a look at only a few random numbers\n\n```{r}\nset.seed(23479)\nN <- 25\ntibble(x = runif(N), y = runif(N)) %>% \n  ggplot(aes(x, y)) +\n  geom_voronoi_tile(aes(fill = y)) +\n  scale_fill_viridis_c(option = 'A') +\n  theme_void() + \n  theme(legend.position = 'none')\n```\n\nNot so super impressive but using many random numbers a \"smoother\" picture will be created.\n\n```{r}\nset.seed(23479)\nN <- 1000\ntibble(x = runif(N), y = runif(N)) %>% \n  ggplot(aes(x, y)) +\n  geom_voronoi_tile(aes(fill = y)) +\n  scale_fill_viridis_c(option = 'A') +\n  theme_void() + \n  theme(legend.position = 'none')\n```\n\nOf course, arranging the center points differently and using other colors leads to very different pictures.\n\n```{r, warning=F}\nset.seed(23479)\nN <- 1000\ntibble(x = runif(N, -1, 1), y = sqrt(abs(x) + runif(N))) %>% \n  ggplot(aes(x, y)) +\n  geom_voronoi_tile(aes(fill = y)) +\n  scale_fill_viridis_c(option = 'E') +\n  theme_void() + \n  theme(legend.position = 'none')\n```\n\n## Sina Plots\n\nComing back to less artistic plots, consider the following violin plots from the `ggplot2` package.\n\n\n```{r}\ndat %>% \n  ggplot(aes(x = species, y = body_mass_g)) +\n  geom_violin(fill = \"grey80\")\n```\n\nCompared with common boxplots, these kind of plots show the distribution of the data more explicitly with density estimates (rotated by 90 degrees and mirrored for symmetry).\nThis gets rid of the intrinsic problem of boxplots, i.e. only showing quantiles.\nSometimes though, we want to see the quantiles as well.\nIn these instances, an additional boxplot is plotted within the violin plots like so.\n\n```{r}\ndat %>% \n  ggplot(aes(x = species, y = body_mass_g)) +\n  geom_violin(fill = \"grey80\") +\n  geom_boxplot(width = 0.25)\n```\n\n\nHowever, even with both of these plots combined we still don't know how many points are in this data set.\nTo make that information available in the visualizations, so-called sina plots fill the area of violin plots with jittered data points instead of depicting the estimated density directly.\n\n```{r}\ndat %>% \n  ggplot(aes(x = species, y = body_mass_g)) +\n  geom_sina()\n```\n\nIf a data set is large, then the points will display the same contour as the violin plot.\nIn any case, the violin plot can be plotted beneath the points as well for better visibility.\n\n\n```{r}\ndat %>% \n  ggplot(aes(x = species, y = body_mass_g)) +\n  geom_violin(fill = \"grey80\") +\n  geom_sina()\n```\n\nThis way, we can see both the distribution AND the number of data points in a single plot.\nOf course, there are more ways to display the distribution of data and `ggdist` is just the right package to do that job.\nI will show you that particular package in the next installment of the [ggplot2-tips series](https://albert-rapp.de/ggplot-series.html).\n\nAnd that concludes our small demonstration of a few `ggforce` functions.\nFor more functions check out [`ggforce`'s website](https://ggforce.data-imaginist.com/).\nFor sure, there is more cool stuff like Bezier curves and facet zooms to explore.\n\nFinally, here is an overview of all the cool visuals we have created.\nLet me know what you think in the comments or simply hit the applause button below if you liked the content.\n\n```{r, echo=F}\nhull_plot <- p +\n  geom_mark_hull(size = 1, concavity = 3) \n\nalluvial <- reshaped_dat %>% \n  ggplot(aes(\n    x = factor(x, c(\"sex\", \"species\", \"island\", \"mass_group\")), \n    split = y, \n    id = id, \n    value = n\n  )) +\n  geom_parallel_sets(aes(fill = sex), alpha = 0.5) +\n  geom_parallel_sets_axes(axis.width = 0.2) +\n  geom_parallel_sets_labels(colour = 'white', size = 4) +\n  labs(x = element_blank()) + \n  scale_y_continuous(breaks = NULL) +\n  theme(text = element_text(size = 12)) +\n  scale_fill_brewer(palette = 'Set1')\n\nset.seed(23479)\nN <- 1000\nvor1 <- \n  tibble(x = runif(N), y = runif(N)) %>% \n  ggplot(aes(x, y)) +\n  geom_voronoi_tile(aes(fill = y)) +\n  scale_fill_viridis_c(option = 'A') +\n  theme_void() + \n  theme(legend.position = 'none')\n\nset.seed(23479)\nN <- 1000\nvor2 <- \n  tibble(x = runif(N, -1, 1), y = sqrt(abs(x) + runif(N))) %>% \n  ggplot(aes(x, y)) +\n  geom_voronoi_tile(aes(fill = y)) +\n  scale_fill_viridis_c(option = 'E') +\n  theme_void() + \n  theme(legend.position = 'none')\n\nviolin_boxplot <- dat %>% \n  ggplot(aes(x = species, y = body_mass_g)) +\n  geom_violin(fill = \"grey80\") +\n  geom_boxplot(width = 0.25)\n\nsina_violin <- dat %>% \n  ggplot(aes(x = species, y = body_mass_g)) +\n  geom_violin(fill = \"grey80\") +\n  geom_sina()\n\ncollected <- (vor1 + vor2 / (violin_boxplot + sina_violin)) + \n  (ellipse_plot / hull_plot) +\n  plot_layout(widths = c(0.4, 0.4, 0.2)) \nggsave(\n  \"collected_plots.png\", \n  collected,\n  width = 30,\n  height = 30 * 9 / 16,\n  units = \"cm\"\n)\nknitr::include_graphics(\"collected_plots.png\")\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"collapse":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["code-filename"],"toc":true,"toc-depth":3,"include-after-body":["../../../footer.html"],"output-file":"05_ggforce_examples.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.0.35","editor":"source","theme":{"light":"../../../theme.scss"},"title-block-banner":false,"author":"Albert Rapp","page-layout":"article","comments":{"utterances":{"repo":"AlbertRapp/blogComments"}},"title":"A couple of visualizations from ggforce","date":"2021-12-31","categories":["Visualization"],"description":"The ggplot2-tips series is continued with a few example plots from the ggforce package","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}}}}