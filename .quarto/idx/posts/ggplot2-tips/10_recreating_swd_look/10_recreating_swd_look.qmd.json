{"title":"Recreating the Storytelling with Data look with ggplot","markdown":{"yaml":{"title":"Recreating the Storytelling with Data look with ggplot","date":"2022-03-29","categories":["Visualization"],"description":"We try to imitate the Storytelling with Data look with ggplot","execute":{"message":false,"warning":false,"collapse":false},"editor_options":{"chunk_output_type":"console"}},"headingText":"Flip the axes for long names","containsRefs":false,"markdown":"\n\n\nSo, I found a [great video](https://www.youtube.com/watch?v=st7_vPjq0SU) from Storytelling with Data (SWD).\nIn this video, a data storyteller demonstrates how a dataviz that does not demonstrate a clear story can be improved.\nLet's take a look at the dataviz but, first, here's the data.\n\n```{r, message=F, warning = F}\nlibrary(tidyverse)\ndat <- tibble(\n  id = 1:19,\n  fulfilled = c(803, 865, 795, 683, 566, 586, 510, 436, 418, 364, 379, 372, 374, 278, 286, 327, 225, 222, 200),\n  accuracy = c(86, 80, 84, 82, 86, 80, 80, 93, 88, 87, 85, 85, 83, 94, 86, 78, 89, 88, 91),\n  error = c(10, 14, 10, 14, 10, 16, 15, 6, 11, 7, 12, 13, 8, 4, 12, 12, 7, 10, 7),\n  null = 100 - accuracy - error\n) %>% \n  mutate(across(accuracy:null, ~. / 100))\ndat\n```\n\nThis data set contains a lot of accuracy and error rates from different (anonymous) warehouses.\nAdditionally, there are \"null rates\". \nThese are likely related to data quality issues.\nFurthermore, this data set is apparently taken from a client the data storytellers helped.\nIn any case, here is a `ggplot2` recreation of the client's initial plot.\nNote that the plot does not match exactly but it's close enough to get the gist.\n\n```{r}\ntheme_set(theme_minimal())\ndat_long <- dat %>% \n  pivot_longer(\n    cols = accuracy:null,\n    names_to = 'type',\n    values_to = 'percent'\n  )\n\ndat_long %>% \n  ggplot(aes(id, percent, fill = factor(type, levels = c('null', 'accuracy', 'error')))) +\n  geom_col() +\n  labs(\n    title = 'Warehouse Accuracy Rates',\n    x = 'Warehouse ID',\n    y = '% of total orders',\n    fill = element_blank()\n  ) +\n  scale_y_continuous(labels = ~scales::percent(., accuracy = 1), breaks = seq(0, 1, 0.1))\n```\n\nAs it is right know, the plot shows data.\nBut what is the message of this dataviz?\nTo make the message more explicit, the plot is transformed during the course of the video.\nTake a look at what story the exact same data can tell.\n\n```{r, echo = F}\nknitr::include_graphics('final.png')\n```\n\nFrom reading the SWD book, I know that some of the techniques that were used in this picture can be used in many settings.\nTherefore, I decided to document the steps I took to recreate the dataviz with ggplot.\n\nI tried to make this documentation as accessible as possible.\nConsequently, if you are already quite familiar with how to customize a ggplot's details, then some of the explanations or references may be superfluous. \nFeel free to skip them.\nThat being said, let's transform the plot.\n\n\nAlthough it is not really an issue here, warehouses or other places might be more identifiable by a (long) name rather than an ID.\nTo make sure that these names are legible, show them on the y-axes.\nWhen I first learned ggplot, there was the layer `coord_flip()` to do that job for us.\nNowadays, though, you can often avoid `coord_flip()` because a lot of geoms already understand what you mean, when you map categorical data to the y-aesthetic.\nBut make sure that ggplot will know that you mean categorical data (especially if the labels are numerical like here).\n\n```{r}\ncategorial_dat <- dat_long %>% \n  mutate(\n    id = as.character(id),\n  )\n\ncategorial_dat %>% \n  ggplot(aes(x = percent, y = id)) +\n  geom_col(\n    aes(group = factor(type, levels = c('error', 'null', 'accuracy'))),\n    col = 'white', # set color to distinguish bars better\n  )\n```\n\nNotice that I used the `group`- instead of `fill`-aesthetic because I only need grouping. \nAlso, it is always a good idea to avoid [excessive use of colors](https://albert-rapp.de/post/2022-02-19-ggplot2-color-tips-from-datawrapper/).\nThis will allow us to emphasize parts of our story with colors later on.\n\n## Add reference points\n\nAnother good idea it to put your data into perspective.\nTo do so, include a reference point.\nThis can be a summary statistic like the average error rate.\nFor more great demonstration of reference points you can also check out [the evolution of a ggplot by CÃ©dric Scherer](https://www.cedricscherer.com/2019/05/17/the-evolution-of-a-ggplot-ep.-1/).\n\n```{r}\naverages <- dat_long %>% \n  group_by(type) %>% \n  summarise(percent = mean(percent)) %>% \n  mutate(id = 'ALL') \n\ndat_with_summary <- categorial_dat %>% \n  bind_rows(averages)\n\ndat_with_summary %>% \n  ggplot(aes(x = percent, y = id)) +\n  geom_col(\n    aes(group = factor(type, levels = c('error', 'null', 'accuracy'))),\n    col = 'white',\n  )\n```\n\n\n## Order your data\n\nTo allow your reader to gain a quick overview, put your data into some form of sensible ordering.\nThis eases the burden of having to make sense of what the visual shows.\nAlso, notice that we already did part of that.\nSee, with the order of the levels in the `group` aesthetic, we influenced the ordering of the stacked bars.\nHere, we made sure that important quantities start at the left resp. right edges.\n\nWhy is that helpful, you ask?\nWell, the bars that start on the left all start at the same reference point.\nTherefore comparisons are quite easy for these bars.\nThe same holds true for the right edge.\nConsequently, it is best that we reserve these vip seats for the important data.\nCheck out what happens if I were to put the accuracy in the middle.\n\n```{r}\ndat_with_summary %>% \n  ggplot(aes(x = percent, y = id)) +\n  geom_col(\n    aes(group = factor(type, levels = c('error', 'accuracy', 'null'))),\n    col = 'white',\n  )\n```\n\nNow, we can't really make out which warehouses have a higher accuracy.\nGiven that the accuracy is likely something we care about, this is bad.\nBut we can change the order even more.\nFor instance, we can also order the bars by error rate.\nHere, `fct_reorder()` is our friend.\n\n```{r}\nordered_dat <- dat_with_summary %>% \n  mutate(\n    type = factor(type, levels = c('error', 'null', 'accuracy')),\n    id = fct_reorder(id, percent, .desc = T)\n  ) \n\nordered_dat %>% \n  ggplot(aes(x = percent, y = id)) +\n  geom_col(\n    aes(group = type),\n    col = 'white',\n  )\n```\n\n## Highlight your story points\n\nNext, it's time to highlight your story points.\nThis can be done with the `gghighlight` as I have demonstrated [in another blog post](https://albert-rapp.de/post/2022-02-19-ggplot2-color-tips-from-datawrapper/#emphasize-just-one-or-a-few-categories).\nAlternatively, we can set the colors manually.\nThe latter approach gave me the best results in this case, so we'll go with that.\nBut I am still a big fan of `gghighlight`, so don't discard its power just yet.\n\n```{r}\n# Set colors as variable for easy change later\nunhighlighted_color <- 'grey80'\nhighlighted_color <- '#E69F00'\navg_error <- 'black'\navg_rest <- 'grey40'\n\n# Compute new column with colors of each bar\ncolored_dat <- ordered_dat %>% \n  mutate(\n    custom_colors = case_when(\n      id == 'ALL' & type == 'error' ~ avg_error,\n      id == 'ALL' ~ avg_rest,\n      type == 'error' & percent > 0.1 ~ highlighted_color,\n      T ~  unhighlighted_color\n    )\n  )\n\np <- colored_dat %>% \n  ggplot(aes(x = percent, y = id)) +\n  geom_col(\n    aes(group = type),\n    col = 'white',\n    fill = colored_dat$custom_colors # Set colors manually\n  )\np\n```\n\nNotice how your eyes are immediately drawn to the intended region.\nThat's the power of colors!\nAlso, note that setting the colors manually like this worked because `fill` in `geom_col()` is vectorized.\nThis is not always the case.\nIn these instances, you may find that [functional programming solves your problem](https://albert-rapp.de/post/2022-03-25-functional-programming-when-geoms-are-not-vectorized/).\n\n## Remove axes expansion and allow drawing outside of grid\n\nDid you notice that there is still some clutter in the plot?\nRemoving clutter from a plot is a central element of the SWD look.\nPersonally, I like this approach. \nSo, let's get down to the essentials and remove what does not need to be there.\nIn this case, there are still (faint) horizontal lines behind each bar.\nFurthermore, this causes the warehouse IDs to be slightly removed from the bars.\nWe change that through formatting the coordinate system with `coord_cartesian()`.\n\n```{r}\np <- p +\n  coord_cartesian(\n    xlim = c(0, 1), \n    ylim = c(0.5, 20.5), \n    expand = F, # removes white spaces at edge of plot\n    clip = 'off' # allows drawing outside of panel\n  )\np\n```\n\nHere, we turned off the expansion to avoid wasting white space.\nNow, the IDs are at their designated place and we do not see lines from their names to the bars anymore.\nIf you want even more power on the space expansion you can leave `expand = T` and modify the expansion for each axis with `scale_*_continuous()` and the `expansion()` function.\nCheck out [Christian Burkhart's neat cheatsheet](https://twitter.com/ChBurkhart/status/1492087527511052290/photo/1) that teaches you everything you need to understand expansions.\n\nOn an unrelated note, you may wonder why I set `clip = 'off'`.\nThis little secret will be revealed soon. \nFor now, just know that it allows you to draw geoms outside the regular panel.\n\n## Move and format axes\n\nYou may have noticed that the x-axis in the finished plot is at the top of the panel rather than at the bottom.\nWhile that is unusual, it helps the reader to get straight to the point as the data is in view earlier.\nThis assumes that the eyes of a typical dataviz reader will first look at the top left corner and then zigzag downwards.\n\nIn `ggplot2`, moving the axes and setting the break points happens in a scale layer.\nIt is here where we use the `scales::percent()` function to transform the axes labels.\nAdditionally, changing labels happens in `labs()` and the remaining axes and text changes happen in `theme()`.\n\n\n```{r}\nunhighlighed_col_darker <- 'grey60'\np <- p +\n  scale_x_continuous(\n    breaks = seq(0, 1, 0.2),\n    labels = scales::percent,\n    position = 'top'\n  ) +\n  labs(\n    title = 'Accuracy rates for highest volume warehouses',\n    y = 'WAREHOUSE ID',\n    x = '% OF TOTAL ORDERS FULFILLED',\n  ) +\n  theme(\n    axis.line.x = element_line(colour = unhighlighed_col_darker),\n    axis.ticks.x = element_line(colour = unhighlighed_col_darker),\n    axis.text = element_text(colour = unhighlighed_col_darker),\n    text = element_text(colour = unhighlighed_col_darker),\n    plot.title = element_text(colour = 'black')\n  )\np\n```\n\nNotice that we have customized the theme elements via `element_*()` functions.\nBasically, each geom type like \"line\", \"rect\", \"text\", etc. has their own `element_*()` function.\nThe `theme()` function expects attributes to be changed using these.\nIf you are unfamiliar with this concept, maybe the corresponding part in my [YARDS lecture notes](https://yards.albert-rapp.de/statquant#themes) will help you.\n\n## Align labels\n\nAligning plot elements, e.g. labels, to form clean lines is another major aspect of the SWD look.\nBefore I read about it, I did not even notice it but once you see it you cannot go back.\nBasically, plots feel \"more harmonious\" if there are clear (not necessarily drawn) lines like with the left and right edge of the stacked bars.\nBut this concept does not stop with the bars and can be used for the labels too.\nLet's demonstrate that by moving the labels with more of `theme()`.\n\n```{r}\np <- p +\n  theme(\n    axis.title.x = element_text(hjust = 0),\n    axis.title.y = element_text(hjust = 1),\n    plot.title.position = 'plot'\n    # aligns the title to the whole plot and not the (inner) panel\n  )\np\n```\n\nOnce again, the design enforces that important information like what's on an axis is in the top left corner.\nThis was done by changing `hjust`. \nIn this case `hjust = 0` corresponds to left-justified whereas `hjust = 1` corresponds to right-justified.\nOf course, `vjust` works similarly.\nFor more details w.r.t. `hjust` and `vjust`, check out [this stackoverflow answer](https://stackoverflow.com/questions/7263849/what-do-hjust-and-vjust-do-when-making-a-plot-using-ggplot) that gives you everything that you need in one visual.\nFor your convenience, here is a slightly changed form of that visual.\n\n```{r, echo = F}\ntd <- expand.grid(\n    hjust=c(0, 0.5, 1),\n    vjust=c(0, 0.5, 1),\n    text=\"text\"\n)\n\nggplot(td, aes(x=hjust, y=vjust)) + \n    geom_point(size = 4, col = 'red') +\n    geom_text(size = 7, aes(label=text, hjust=hjust, vjust=vjust)) + \n    scale_x_continuous(breaks=c(0, 0.5, 1), expand=c(0, 0.2)) +\n    scale_y_continuous(breaks=c(0, 0.5, 1), expand=c(0, 0.2))\n```\n\n\nBut once you start aligning the axes titles, you notice that the 0% and 100% labels fall outside the grid.\nWe could try to set `hjust` of `axis.text.x` in `theme()` but sadly this is not vectorized.\nSubsequently, all `hjust` values must be the same.\nThat's not bueno.\nTherefore, I drew the axes labels manually with `annotate()` but make sure that you remove the current labels in `scale_x_continuous()`.\nAlso, now you know why we had to set `clip = 'off'` earlier.\nThe axes labels are outside of the regular panel.\n\n```{r}\np <- p +\n  # Overwriting previous scale will generate a warning but that's ok\n  scale_x_continuous(\n    breaks = seq(0, 1, 0.2), # We still want the axes ticks\n    labels = rep('', 6), # Empty strings as labels\n    position = 'top'\n  ) +\n  annotate(\n    'text',\n    x = seq(0, 1, 0.2),\n    y = 20.75,\n    label = scales::percent(seq(0, 1, 0.2), accuracy = 1),\n    size = 3,\n    hjust = c(0, rep(0.5, 4), 1),\n    # individual hjust here\n    vjust = 0, \n    col = unhighlighed_col_darker\n  ) +\n  theme(\n    axis.title.x = element_text(hjust = 0, vjust = 0)\n    # change vjust to avoid overplotting\n  )\np\n```\n\n## Add text labels\n\nThe same trick can be used to add the category description (accuracy, null, error) to the right top corner and label the highlighted bars.\nFor the latter part, we simply extract the corresponding rows from our data and use that in conjunction with `geom_text()`.\n\n```{r}\ntext_labels <- colored_dat %>% \n  filter(type == 'error', percent > 0.1) %>% \n  mutate(percent = scales::percent(percent, accuracy = 1))\n\np <- p +\n  geom_text(\n    data = text_labels, \n    aes(x = 1, label = percent), \n    hjust = 1.1,\n    col = 'white',\n    size = 4\n  )\np\n```\n\nNotice that I used a `hjust` value greater than 1 here to add some white space on the right side of the labels.\nOtherwise, the percent sign will be too close to the bar's edge.\n\nNext, we add the category descriptions.\nThis is a bit more tricky, though, because we want to highlight a word too,\nSo, we will add a `richtext` as described [in my previous blog post](https://albert-rapp.de/post/2022-02-19-ggplot2-color-tips-from-datawrapper/#label-directly).\n\n```{r}\nlibrary(ggtext)\np <- p +\n  annotate(\n    'richtext',\n    x = 1,\n    y = 21.25,\n    label = \"ACCURATE | NULL | <span style = 'color:#E69F00'>ERROR</span>\",\n    hjust = 1,\n    vjust = 0, \n    col = unhighlighed_col_darker, \n    size = 4,\n    label.colour = NA,\n    fill = NA\n  )\np\n```\n\n\n\n## Add story text\n\nNow that the bar plot is finished we can work on the story text.\nFor that, we create another plot that contains only the text.\nLater on, we will combine both of our plots with the `patchwork` package.\nThere are no really knew techniques here, so let's get straight to the code.\n\n```{r}\n# Save text data in a tibble\ntib_summary_text <- tibble(\n  x = 0, \n  y = c(1.65, 0.5), \n  label = c(\"<span style = 'color:grey60'>OVERALL:</span> **The error rate is 10% across all<br>66 warehouses**. <span style = 'color:grey60'>The good news is that<br>the accuracy rate is 85% so we\\'re hitting<br>the mark in nearly all our centers due to<br>the quality initiatives implemented last year.</span>\",\n  \"<span style = 'color:#E69F00'>OPPORTUNITY TO IMPROVE:</span> <span style = 'color:grey60'>10 centers<br>have higher than average error rates of<br>10%-16%.</span> <span style = 'color:#E69F00'>We recommend investigating<br>specific details and **scheduling meetings<br>with operations managers to<br>determine what's driving this.**</span>\"\n  )\n)\n\n# Create text plot with geom_richtext() and theme_void()\ntext_plot <- tib_summary_text %>% \n  ggplot() +\n  geom_richtext(\n    aes(x, y, label = label),\n    size = 3,\n    hjust = 0,\n    vjust = 0,\n    label.colour = NA\n  ) +\n  coord_cartesian(xlim = c(0, 1), ylim = c(0, 2), clip = 'off') +\n  # clip = 'off' is important for putting it together later.\n  theme_void()\ntext_plot\n```\n\n\n## Add main message as new title and subtitle\n\nAs I said before, we will put the two plots together with `patchwork`.\nIf you have never dealt with `patchwork`, feel free to check out my short [intro to patchwork](https://albert-rapp.de/post/2021-10-28-extend-plot-variety/).\nPutting the plots together gives us another opportunity: \nWe can now set additional titles and subtitles of the **whole** plot.\nUse these to add the main message of your plot.\n\nBut make sure that there is enough white space around them by setting the title margins in `theme()`.\nOtherwise, your plot will feel \"too full\".\nAdding spacing is achieved through a `margin()` function in `element_text()`.\nThough, in this case we use `element_markdown()` which works exactly the same but enables [Markdown syntax](https://www.markdownguide.org/basic-syntax/) like using asterisks for bold texts.\n\n```{r, eval = F}\n# Save texts as variables for better code legibility\n# Here I used Markdown syntax\n# To enable its rendering, use element_markdown() in theme\ntitle_text <- \"**Action needed:** 10 warehouses have <span style = 'color:#E69F00'>high error rates</span>\"\nsubtitle_text <- \"<span style = 'color:#E69F00'>DISCUSS:</span> what are <span style = 'color:#E69F00'>**next steps to improve errors**</span> at highest volume warehouses?<br><span style = 'font-size:10pt;color:grey60'>The subset of centers shown (19 out of 66) have the highest volume of orders fulfilled</span>\"\ncaption_text <- \"SOURCE: ProTip Dashboard as of Q4/2021. See file xxx for additional context on remaining 47 warehouses<br><span style = 'font-size:6pt;color:grey60'>Original: Storytelling with Data - improve this graph! exercise | {ggplot2} remake by Albert Rapp (@rappa753).\"\n\n# Compose plot\nlibrary(patchwork)\np +\n  text_plot +\n  # Make text plot narrower\n  plot_layout(widths = c(0.6, 0.4)) +\n  # Add main message via title and subtitle\n  plot_annotation(\n    title = title_text,\n    subtitle = subtitle_text,\n    caption = caption_text,\n    theme = theme(\n      plot.title = element_markdown(\n        margin = margin(b = 0.4, unit = 'cm'),\n        # 0.4cm margin at bottom of title\n        size = 16\n      ),\n      plot.subtitle = element_markdown(\n        margin = margin(b = 0.4, unit = 'cm'),\n        # 0.4cm margin at bottom of title\n        size = 11.5\n      ),\n      plot.caption.position = 'plot',\n      plot.caption = element_markdown(\n        hjust = 0, \n        size = 7, \n        colour = unhighlighed_col_darker, \n        lineheight = 1.25\n      ),\n      plot.background = element_rect(fill = 'white', colour = NA)\n      # This is only a trick to make sure that background really is white\n      # Otherwise, some browsers or photo apps will apply a dark mode\n    )\n  ) \n```\n\n```{r, echo = F}\nknitr::include_graphics('final.png')\n```\n\n\n## Get the sizes right\n\nIn the last plot, I cheated.\nI gave you the correct code I used to generate the picture.\nBut I did not execute it.\nInstead, I only displayed the code and then showed you the (imported) picture from the start of this blog post.\nWhy did I do this?\nBecause getting the sizes right sucks!\n\nIf you have dealt with ggplot enough, then you will know that text sizes are often set in absolute rather than in relative terms.\nTherefore, if you make the bar plot smaller in width (like we did), then the bars may be appropriately scaled to the new width but, more often than not, the texts are not.\nIn this case, this led to way too large fonts as beautifully demonstrated in [Christophe Nicault's helpful blog post](https://www.christophenicault.com/post/understand_size_dimension_ggplot2/).\n\nSo, how do you avoid this?\nFirst off, choose size and [fonts](https://albert-rapp.de/post/2022-03-04-fonts-and-icons/) last (choose the font first, though). \nThis will save you a lot of repetitive work when you change the alignment in your plot.\nBut this tip will only get you so far, because you have to fix some sizes in between to get a feeling for the visualization you are trying to create.\n\nTherefore, try to get you canvas into an appropriate size first.\nI try to do this by using the `camcorder` package at the start of my visualization process.\nThis will ensure that my plots are saved as a png-file with predetermined dimensions and the resulting file is displayed in the Viewer pane in RStudio (as opposed to the Plots pane).\n\nFor example, at the start of working on this visualization I have called\n\n```{r, eval = F}\ncamcorder::gg_record(\n  dir = 'img', dpi = 300, width = 16, height = 9, units = 'cm'\n)\n```\n\nThis made getting the sizes right for my final output somewhat easier because the canvas size remains the same throughout the process.\nThough be sure to call `gg_record()` **after** `library(ggtext)` or make sure that you call `gg_record()` again if you add `ggtext` only later.\nOtherwise, your plots will revert back to being displayed in the Plots pane (with relative sizing).\nFinally, if you want to use `camcorder` in conjunction with `showtext`, then be sure that `showtext` will know what dpi value you chose when calling `gg_record()`.\n\n```{r, eval = F}\nshowtext::showtext_opts(dpi = 300)\n```\n\nAlright, that concludes this somewhat long blog post. I hope that you enjoyed it and learned something valuable.\nIf you did, feel free to leave a comment.\nAlso, you can stay in touch with my work by subscribing to my [RSS feed](https://albert-rapp.de/blog.xml) or following me on [Twitter](https://twitter.com/rappa753).\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"message":false,"collapse":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"self-contained-math":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"include-after-body":["../../../footer.html"],"output-file":"10_recreating_swd_look.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"editor":"source","theme":"../../../theme.scss","title-block-banner":false,"author":"Albert Rapp","page-layout":"article","comments":{"utterances":{"repo":"AlbertRapp/blogComments"}},"title":"Recreating the Storytelling with Data look with ggplot","date":"2022-03-29","categories":["Visualization"],"description":"We try to imitate the Storytelling with Data look with ggplot","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}}}}