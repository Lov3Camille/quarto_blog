{"title":"4 Ways to use colors in ggplot more efficiently","markdown":{"yaml":{"title":"4 Ways to use colors in ggplot more efficiently","date":"2022-02-19","categories":["Visualization"],"description":"Inspired by a datawrapper blogpost, we explore how to work with fewer colors in ggplot.","execute":{"message":false,"warning":false,"collapse":false},"editor_options":{"chunk_output_type":"console"}},"headingText":"| echo: false","containsRefs":false,"markdown":"\n\n```{r}\n#| results: 'hide'\nrenv::use(lockfile = \"renv.lock\")\n```\n\nWhen creating a plot I frequently catch myself using way too many colors. Thus, I have to remind myself often to keep things simple.\nUsually, this makes a data visualization way more effective.\n\nLuckily, I found a neat [datawrapper blogpost](https://blog.datawrapper.de/10-ways-to-use-fewer-colors-in-your-data-visualizations/) by [Lisa Charlotte Muth](https://twitter.com/lisacmuth) that shows us how to reduce the use of colors.\n\nBut as I was reading the blog post, I found myself wondering how some of the mentioned principles could be implemented in ggplot.\nNaturally, I began experimenting and created a few example plots using fewer colors.\nThis post will show you how you can do that too.\n\n## Preliminaries\n\nFor completeness' sake, let me mention the basic settings I will use for all visualizations.\nHonestly, if you have no idea what happens in the following code chunk, just skip it. \nMore or less, this chunk makes sure that all plots are using `theme_minimal()` plus a small number of tweaks.\nThese tweaks are\n\n- The use of the [Fira Sans font](https://fonts.google.com/specimen/Fira+Sans) with help from the `showtext` package.\n- The plot titles are aligned to the left, have some spacing around them and are colored using a color from the [Okabe Ito](https://jfly.uni-koeln.de/color/) color palette. Ever since I read [Fundamentals of Data Visualization by Claus Wilke](https://clauswilke.com/dataviz/), I am fond of this color palette as I find the colors nice and apparently it is also color-blind safe. \n\n```{r, warnings = F, message = F}\nlibrary(tidyverse)\nlibrary(showtext)\nfont_add_google(\"Fira Sans\", \"firasans\")\nshowtext_auto()\n\ntheme_customs <- theme(\n  text = element_text(family = 'firasans', size = 16),\n  plot.title.position = 'plot',\n  plot.title = element_text(\n    face = 'bold', \n    colour = thematic::okabe_ito(8)[6],\n    margin = margin(t = 2, r = 0, b = 7, l = 0, unit = \"mm\")\n  ),\n)\n\ntheme_set(theme_minimal() + theme_customs)\n```\n\n\n## Show shades, not hues\n\nAlright, enough with the preliminaries.\nLet's count how many different car classes are represented in the `mpg` dataset from the `ggplot2` package.  I am sure you have seen the data already when you read this ggplot post. So, no further comment on this data set.\n\n```{r}\nmpg %>% \n  ggplot(aes(x = year, fill = class)) +\n  geom_bar()\n```\n\nUgh, this is a colorful mess and sort of reminds me of the [gnome rainbow puking gif](https://giphy.com/gifs/gravity-falls-i-couldnt-put-it-up-last-night---because-either-id-flip-out-and-wosNsGaxczbIA).\nLet's reduce the color load by sticking to only three colors.\nTo differentiate between classes we will make some colors more transparent. \n\nThus, we need to create a new variable in our data set that lumps the classes into three groups (for the colors).\n\n```{r}\n# Group classes into three groups (to reduce colors to 3)\ndat <- mpg %>% \n  mutate(\n    year = factor(year),\n    class_group = case_when(\n      class %in% c('2seater', 'compact', 'midsize') ~ \"grp1\",\n      class == 'minivan' ~ \"grp2\",\n      T ~ \"grp3\"\n    )\n  )\n```\n\nNow that this is done, we can map `fill` to our new `class_group` variable and the regular `class` variable to `alpha`.\n\n```{r, warning=F}\nshades_plt <- dat %>% \n  ggplot(aes(x = year, fill = class_group, alpha = class)) +\n  geom_bar() +\n  labs(\n    x = 'Year',\n    y = 'Counts',\n    alpha = 'Class',\n    title = 'Show shades, not hues'\n  )\nshades_plt \n```\n\nFor better control of the visuals let us manually create and assign colors and the transparency levels.\n\n```{r}\n# Color-blind safe colors\ncolors <-  thematic::okabe_ito(3)\n# Possible levels of transparency (one for each class)\nalpha_max <- 1\nalpha_min <- 0.7\nalpha_vals <- c(\n  seq(alpha_max, alpha_min, length.out = 4), \n  seq(alpha_min, alpha_max, length.out = 4)[-1]\n)\nalpha_vals\n\n# Tweak previous plot\nshades_plt <- shades_plt +\n  scale_fill_manual(values = colors) +\n  scale_alpha_manual(values = alpha_vals)\nshades_plt\n```\n\nNext, let us consolidate the two legends into one.\nThis can be done via `guides()`.\nHere, the `fill` guide will be set to `guide_none()` to get rid of the `class_group` legend.\n\nAlso, the `alpha` guide needs to be manually overwritten via `override.aes` in `guide_legend()` using the color codes that we saved in the vector `colors`.\nThis way, the `alpha` legend will also depict the colors instead of only the transparency level.\n\n```{r}\nshades_plt <- shades_plt +\n  guides(\n    fill = guide_none(),\n    alpha = guide_legend(\n      override.aes = list(fill = colors[c(1, 1, 1, 2, 3, 3, 3)]\n      )\n    )\n  ) \nshades_plt\n```\n\n## Group categories together by color, but keep showing them\n\nSo, this already looks better.\nHowever, adjacent colored blocks now \"merge\" into each other. \nThis can make it hard to differentiate between classes.\n\nTo overcome this issue, add lines between blocks.\nLuckily, this is spectacularly easy and done by setting the `color` aesthetic in `geom_bar()` to white.\nHere's the complete code.\n\n```{r}\ndat %>% \n  ggplot(aes(x = year, fill = class_group, alpha = class)) +\n  geom_bar(col = 'white') + # Add lines for distinction\n  scale_fill_manual(values = colors) +\n  scale_alpha_manual(values = alpha_vals) +\n  guides(\n    fill = guide_none(),\n    alpha = guide_legend(override.aes = list(fill = colors[c(1, 1, 1, 2, 3, 3, 3)]))\n  ) +\n  labs(\n    x = 'Year',\n    y = 'Counts',\n    alpha = 'Class',\n    title = 'Group categories together by color, \\nbut keep showing them'\n  )\n```\n\n\n## Emphasize just one or a few categories\n\nNext, let us switch tracks and look at some other kind of data.\nAt [Our World in Data](https://ourworldindata.org/time-with-others-lifetime) you can find a lot of interesting data sets.\nOne of these contains survey information on who Americans spend their time with (in average minutes per day by age). If you download this data set, you can create a plot like this.\n\n```{r, message=F}\n# Some data wrangling\ntime_data <- read_csv(\"time-spent-with-relationships-by-age-us.csv\") %>% \n  rename_with(\n    ~c('Entitity', 'Code', 'Age', 'alone', 'friends', 'children', 'parents', \n       'partner', 'coworkers')\n  ) %>% \n  pivot_longer(\n    cols = alone:coworkers, \n    names_to = 'person',\n    values_to = 'minutes'\n  ) %>% \n  janitor::clean_names() %>% \n  filter(age <= 80) \n\n# Color-blind safe colors\ncolors <- thematic::okabe_ito(8)[-6]\n\n# Line plot\np <- time_data %>% \n  ggplot(aes(x = age, y = minutes, col = person)) +\n  geom_line(size = 1.5) +\n  scale_color_manual(values = colors) +\n  coord_cartesian(xlim = c(15, 81), expand = F) +\n  scale_y_continuous(minor_breaks = NULL) +\n  labs(x = 'Age (in years)', y = 'Minutes', col = 'Time spent')\np\n```\n\nOnce again, we created a plot with loads of color. If this were an interactive plot where we can focus on one line at a time, this would not necessarily be a problem. However, as it is, this is a rather messy spaghetti plot and extracting meaning from it is hard. \n\nBut if we know what story we want to tell, then we can save this plot by emphasizing only the important parts.\nThis is where the `gghighlight` package shines.\nIt works by adding a `gghighlight()` layer to an existing plot with conditions for filtering. \nAll data points that do not fulfill these conditions are greyed out.\n\n```{r, warning = F}\nlibrary(gghighlight)\nalone_plt <- p + \n  gghighlight(person == 'alone', use_direct_label = F) +\n  labs(title = 'Emphasize just one or a few categories')\nalone_plt\n```\n\nFinally, we are only one text annotation away from telling a story.\n\n```{r, warning = F}\nalone_plt +\n  annotate(\n    'text',\n    x = 15,\n    y = 455,\n    label = 'We spend a lot of time alone...',\n    hjust = 0,\n    vjust = 0,\n    family = 'firasans',\n    size = 7\n  )\n```\n\nOf course, a data set may contain multiple stories that may also need multiple highlights. \nNo problem. \nWith `gghighlight()` we can combine as many conditions as we like.\n\n```{r, warning = F}\nage_40_plt <- p + \n  gghighlight(\n    person %in% c('alone', 'children'), \n    age >= 38, \n    use_direct_label = F\n  ) +\n  geom_segment(x = 38, xend = 38, y = -Inf, yend = 300, linetype = 2, col = 'grey20') +\n  labs(title = 'Emphasize just one or a few categories') \n\nage_40_plt +\n  annotate(\n    'text',\n    x = 15,\n    y = 403,\n    label = 'Around the age of 40, we spend \\nless time with children and \\nmore time alone.',\n    hjust = 0,\n    vjust = 0,\n    family = 'firasans',\n    lineheight = 0.85,\n    size = 5.5\n  )\n```\n\n\n## Label directly\n\nIn all previous plots, we displayed a legend at the side of the plot. \nHowever, this requires quite a large amount of space which we can save by direct labeling (either with `annotate()` for a single label or `geom_text()` for multiple labels).\n\n```{r}\nalone_plt +\n  annotate(\n    'text',\n    x = 15,\n    y = 455,\n    label = 'We spend a lot of time alone...',\n    hjust = 0,\n    vjust = 0,\n    family = 'firasans',\n    size = 7\n  ) +\n  annotate(\n    'text', \n    x = 70, \n    y = 420, \n    label = 'alone',\n    hjust = 0,\n    vjust = 0,\n    size = 7,\n    family = 'firasans',\n    color = colors[1]\n  ) +\n  labs(title = 'Label directly') +\n  theme(legend.position = 'none')\n```\n\nThis way, we save a lot of space and can give the remaining part of the plot more room.\nAlso, this saves the reader some cognitive effort because one does not have to switch back and forth between legend and actual plot.\n\nIn this particular case, there is another option for direct labelling. \nNotice how close the word 'alone' from the original text annotation is to the highlighted line anyway.\nTherefore, we may as well save us one additional annotation and colorize a single word in the orginal annotation.\n\nTo do so, the `ggtext` package and a bit of HTML magic will help us. Basically, what we need is to change the annotation from `text` geom to `richtext` geom and create a string that contains the HTML-code for colored text. Here that is `<span style = 'color:#E69F00;'>...</span>`.\n\n```{r}\nlibrary(ggtext)\ncolor_alone <- glue::glue(\n  \"We spend a lot of time <span style = 'color:{colors[1]};'>alone</span>...\"\n)\ncolor_alone\nalone_plt +\n  labs(title = 'Label directly') +\n  annotate(\n    'richtext',\n    x = 15,\n    y = 400,\n    label = color_alone,\n    hjust = 0,\n    vjust = 0,\n    family = 'firasans',\n    size = 7,\n    label.color = NA\n  ) +\n  theme(legend.position = 'none')\n```\n\nNaturally, we can do this for our second highlighted plot as well.\nIn this case, the colored key words are not adjacent to the actual lines. \n\n```{r}\nage_40_text <- glue::glue(\n  \"Around the age of 40, we spent less <br> time with \n  <span style = 'color:{colors[2]};'>children</span> \n  and more <br> time <span style = 'color:{colors[1]};'>alone</span>.\"\n)\n\nage_40_plt +\n  labs(title = 'Label directly') +\n  annotate(\n    'richtext',\n    x = 15,\n    y = 400,\n    label = age_40_text,\n    hjust = 0,\n    vjust = 0,\n    family = 'firasans',\n    lineheight = 1.25,\n    size = 5.5,\n    label.color = NA\n  ) +\n  theme(legend.position = 'none')\n```\n\nConsequently, the reader may have to go back and forth between text and lines again but still we used our space more efficiently. So, I will let this count as direct labeling.\n\nFinally, let us come full circle and return to our initial bar plot.\nThis one could also use some direct labels.\nNormally, I would simply add a `geom_text()` layer together with `position_stack()` to the initial plot as described [here](https://albert-rapp.de/post/2021-09-11-position-adjustment/).\n\nBut for some magical reason, this did not align the labels properly and it was driving me crazy.\nTherefore, I counted the car classes and computed the label positions manually.\n\n```{r}\nmanual_counts <- mpg %>% \n  count(year, class) %>% \n  mutate(\n    year = factor(year),\n    class_group = case_when(\n      class %in% c('2seater', 'compact', 'midsize') ~ \"grp1\",\n      class == 'minivan' ~ \"grp2\",\n      T ~ \"grp3\"\n    )\n  ) \n\nlabels <- manual_counts %>% \n  mutate(class = factor(class)) %>%  \n  group_by(year) %>% \n  arrange(year, desc(class)) %>% \n  mutate(\n    csum = cumsum(n), \n    n = (lag(csum, default = 0) + csum) / 2\n  )\n```\n\nBut once this small detour is overcome, we can label the plot in the same manner as before.\nUnfortunately, the `2seater` class is so small that the label wouldn't fit into the box. \nTherefore, I decided to plot the label on top.\n\n```{r}\nmanual_counts %>% \n  ggplot(aes(x = year, y = n, fill = class_group)) +\n  geom_col(aes(alpha = class), col = 'white') +\n  scale_fill_manual(values = colors) +\n  scale_alpha_manual(values = alpha_vals) +\n  labs(\n    x = 'Year',\n    y = 'Counts',\n    alpha = 'Class',\n    title = 'Label directly'\n  ) +\n  # Add all but one label\n  geom_text(\n    data = labels %>% filter(class != '2seater'),\n    aes(label = class), \n    col = 'white',\n    family = 'firasans',\n    size = 5,\n    fontface = 'bold'\n  ) +\n  # Add 2seater label\n  geom_text(\n    data = labels %>% filter(class == '2seater'),\n    aes(y = n + 3, label = class), \n    col = 'black',\n    family = 'firasans',\n    size = 5,\n    fontface = 'bold'\n  ) +\n  theme(legend.position = 'none') \n```\n\n## Closing remarks\n\nThe [blog post that inspired this post](https://blog.datawrapper.de/10-ways-to-use-fewer-colors-in-your-data-visualizations) contains a few more tips like using other indicators than color and you should definitely check it out. \nAlso, Lisa Muth apparently writes a book on colors in data visualizations and documents her thoughts [here](https://datawrapper.notion.site/Color-Book-Updates-54905c2bd0bb4c6bae15d99e31a9d5c4). \nIf you look for more content on colors, this might be a fountain of information.\n\nAs for using patterns instead of colors, I recently wrote a [blog post](https://albert-rapp.de/posts/ggplot2-tips/07_four_ways_colors_more_efficiently/07_four_ways_colors_more_efficiently.html) that leverages the `ggpattern` package to do just that. \nCheck it out [here](https://albert-rapp.de/posts/ggplot2-tips/07_four_ways_colors_more_efficiently/07_four_ways_colors_more_efficiently.html). And as always, if you don't want to miss new blog post, either follow me on [Twitter](https://twitter.com/rappa753) or via my [RSS feed](https://albert-rapp.de/blog.xml).\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"collapse":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["code-filename","lightbox"],"toc":true,"toc-depth":3,"include-after-body":["../../../footer.html"],"output-file":"07_four_ways_colors_more_efficiently.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.0.35","lightbox":"auto","editor":"source","theme":{"light":"../../../theme.scss"},"title-block-banner":false,"author":"Albert Rapp","page-layout":"article","comments":{"utterances":{"repo":"AlbertRapp/blogComments"}},"title":"4 Ways to use colors in ggplot more efficiently","date":"2022-02-19","categories":["Visualization"],"description":"Inspired by a datawrapper blogpost, we explore how to work with fewer colors in ggplot.","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}}}}